<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('level_css').getContent(); ?>
</head>

<body>
  <header>
    <div class="header-links">
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>">å‹¤æ€ ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=health">ä½“èª¿ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=level">ç›®æ¨™ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=form">äº¤ä»£ç”³è«‹ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </div>
  </header>

<div class="container">

  <? 
  var goalRecord = getLatestGoalRecord();
  var currentSalary = calculateCurrentSalary();
  var goals = [];
  var highestAchievedLevel = 0;

  if (goalRecord) {
    goals = [
      { level: 1, text: goalRecord[1], amount: Number(goalRecord[2] || 0) },
      { level: 2, text: goalRecord[3], amount: Number(goalRecord[4] || 0) },
      { level: 3, text: goalRecord[5], amount: Number(goalRecord[6] || 0) }
    ];
    var cumulativeAmount = 0;
    goals.forEach(function(goal) {
      cumulativeAmount += goal.amount;
      if (currentSalary >= cumulativeAmount) {
        highestAchievedLevel = goal.level;
      }
    });
  }
  ?>

  <div class="card1">
    <? if (goalRecord) { ?>

      <div>
        <h3>ç¾åœ¨ã®ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«</h3>
        <div class="current-level-summary">
          ã‚ãªãŸã®ç¾åœ¨ã®ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«ã¯ <strong>Lv. <?= highestAchievedLevel ?></strong> ã§ã™ï¼
        </div>
      </div>

      <div>
        <h3>ç›®æ¨™åˆ°é”åº¦ï¼ˆè©³ç´°ï¼‰</h3>
        <?
        var previousTotalAmount = 0;
        goals.forEach(function(goal) {
          if (goal.amount > 0) {
            var progressForThisLevel = currentSalary - previousTotalAmount;
            var rate = (progressForThisLevel / goal.amount) * 100;
        ?>
            <div>
              <h4>Lv <?= goal.level ?>: <?= goal.text ?> ã®ãŸã‚ã« <?= goal.amount.toLocaleString() ?> å††ç¨¼ã</h4>
              <p class="goal-status">
                <? if (rate >= 100) { ?>
                  <strong class="achieved">100% é”æˆï¼ğŸ‰</strong>
                <? } else if (rate < 0) { ?>
                  é”æˆç‡: <strong>0%</strong> (ã‚ã¨ <strong><?= goal.amount.toLocaleString() ?></strong> å††)
                <? } else { 
                    var remaining = goal.amount - progressForThisLevel;
                ?>
                  é”æˆç‡: <strong><?= Math.round(rate) ?>%</strong> (ã‚ã¨ <strong><?= Math.round(remaining).toLocaleString() ?></strong> å††)
                <? } ?>
              </p>
            </div>
        <? 
            previousTotalAmount += goal.amount;
          }
        });
        ?>
      </div>

    <? } else { ?>
      <div>
        <p>ç›®æ¨™ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œç›®æ¨™ã‚’è¨­å®š / ç·¨é›†ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    <? } ?>

    <div>
      <h3>ç›®æ¨™è¨­å®š</h3>
      <button type="button" id="toggleGoalFormBtn" class="btn">ç›®æ¨™ã‚’è¨­å®š / ç·¨é›†ã™ã‚‹</button>
      <div id="goalFormWrapper" style="display: none; margin-top: 20px;">
        <form id="goalRecordForm" onsubmit="handleGoalRecordFormSubmit(this); return false;">
          <div class="goal-input-group">
            <label>Level 1ï¼š</label><input type="text" name="first_text" placeholder="ä¾‹ï¼šå®¶è³ƒ"><span>ã®ãŸã‚</span><input type="number" name="first_money" placeholder="50000"><span>å††ç¨¼ãï¼</span>
          </div>
          <div class="goal-input-group">
            <label>Level 2ï¼š</label><input type="text" name="second_text" placeholder="ä¾‹ï¼šãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚°"><span>ã®ãŸã‚</span><input type="number" name="second_money" placeholder="20000"><span>å††ç¨¼ãï¼</span>
          </div>
          <div class="goal-input-group">
            <label>Level 3ï¼š</label><input type="text" name="third_text" placeholder="ä¾‹ï¼šæ—…è¡Œ"><span>ã®ãŸã‚</span><input type="number" name="third_money" placeholder="10000"><span>å††ç¨¼ãï¼</span>
          </div>
          <div class="btn-frame">
            <input type="submit" value="ç™»éŒ²" class="btn"/><div id="goal_submit_message"></div>
          </div>
        </form>
      </div>
    </div>
    
  </div>

  <div class="card2">
    
    <div>
      <h3>ä»Šæœˆã®çµ¦ä¸ï¼ˆç›®å®‰ï¼‰</h3>
      <p class="salary-display">
        <?= typeof currentSalary === 'number' ? currentSalary.toLocaleString() + ' å††' : 'è¨ˆç®—ä¸­...' ?>
      </p>
    </div>

    <? if (goalRecord) { ?>
      <div>
        <h3>ç›®æ¨™é”æˆã‚°ãƒ©ãƒ•</h3>
        <div class="charts-grid">
          <div class="chart-item"><h4>Lv 1</h4><canvas id="goalChart1"></canvas></div>
          <div class="chart-item"><h4>Lv 2</h4><canvas id="goalChart2"></canvas></div>
          <div class="chart-item"><h4>Lv 3</h4><canvas id="goalChart3"></canvas></div>
        </div>
      </div>
    <? } ?>
    </div>
</div>

  <script>
  window.addEventListener('load', function() {
    document.getElementById('goalRecordForm').addEventListener('submit', function(event) {
      event.preventDefault();
    });


    google.script.run.withSuccessHandler(drawGoalCharts).getGoalAndSalaryData();

    const toggleBtn = document.getElementById('toggleGoalFormBtn');
    const goalForm = document.getElementById('goalFormWrapper');
    if (toggleBtn && goalForm) {
      toggleBtn.addEventListener('click', function() {
        const isHidden = goalForm.style.display === 'none';
        goalForm.style.display = isHidden ? 'block' : 'none';
        this.textContent = isHidden ? 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹' : 'ç›®æ¨™ã‚’è¨­å®š / ç·¨é›†ã™ã‚‹';
      });
    }
  });

  /** ç›®æ¨™ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ãƒãƒ³ãƒ‰ãƒ© */
  function handleGoalRecordFormSubmit(formObject) {
    const goalData = {
      first_text: formObject.first_text.value,
      first_money: formObject.first_money.value,
      second_text: formObject.second_text.value,
      second_money: formObject.second_money.value,
      third_text: formObject.third_text.value,
      third_money: formObject.third_money.value,
    };
    
    updateGoalRecordMessage('ç™»éŒ²ä¸­...');
    google.script.run.withSuccessHandler(function(response) {
      updateGoalRecordMessage(response);
      setTimeout(() => window.location.reload(), 2000);
    }).saveGoalRecord(goalData);
  }
  
  /** ç›®æ¨™ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–° */
  function updateGoalRecordMessage(message) {
    document.getElementById('goal_submit_message').innerHTML = message;
  }

  /** 3ã¤ã®å††ã‚°ãƒ©ãƒ•ã‚’æç”» */
  function drawGoalCharts(goalData) {
    if (!goalData) return;
    goalData.forEach(function(goal, index) {
      const ctx = document.getElementById('goalChart' + (index + 1)).getContext('2d');
      const percentage = goal.percentage;
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{ data: [percentage, 100 - percentage], backgroundColor: ['#28a745', '#e9ecef'] }]
        },
        options: {
          responsive: true, cutout: '70%',
          plugins: {
            legend: { display: false }, tooltip: { enabled: false },
            title: { display: true, text: percentage + '%', position: 'bottom', font: { size: 24, weight: 'bold' } }
          }
        }
      });
    });
  }
  </script>
</body>

</html>