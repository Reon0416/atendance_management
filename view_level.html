<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('level_css').getContent(); ?>
</head>

<body>
  <header>
    <div class="header-links">
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>">勤怠ページ</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=health">体調ページ</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=level">目標ページ</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=form">交代申請ページ</a>
      <a href="<?= getAppUrl() ?>">ホームに戻る</a>
    </div>
  </header>

<div class="container">

  <? 
  var goalRecord = getLatestGoalRecord();
  var currentSalary = calculateCurrentSalary();
  var goals = [];
  var highestAchievedLevel = 0;

  if (goalRecord) {
    goals = [
      { level: 1, text: goalRecord[1], amount: Number(goalRecord[2] || 0) },
      { level: 2, text: goalRecord[3], amount: Number(goalRecord[4] || 0) },
      { level: 3, text: goalRecord[5], amount: Number(goalRecord[6] || 0) }
    ];
    var cumulativeAmount = 0;
    goals.forEach(function(goal) {
      cumulativeAmount += goal.amount;
      if (currentSalary >= cumulativeAmount) {
        highestAchievedLevel = goal.level;
      }
    });
  }
  ?>

  <div class="card1">
    <? if (goalRecord) { ?>

      <div>
        <h3>現在の目標達成レベル</h3>
        <div class="current-level-summary">
          あなたの現在の目標達成レベルは <strong>Lv. <?= highestAchievedLevel ?></strong> です！
        </div>
      </div>

      <div>
        <h3>目標到達度（詳細）</h3>
        <?
        var previousTotalAmount = 0;
        goals.forEach(function(goal) {
          if (goal.amount > 0) {
            var progressForThisLevel = currentSalary - previousTotalAmount;
            var rate = (progressForThisLevel / goal.amount) * 100;
        ?>
            <div>
              <h4>Lv <?= goal.level ?>: <?= goal.text ?> のために <?= goal.amount.toLocaleString() ?> 円稼ぐ</h4>
              <p class="goal-status">
                <? if (rate >= 100) { ?>
                  <strong class="achieved">100% 達成！🎉</strong>
                <? } else if (rate < 0) { ?>
                  達成率: <strong>0%</strong> (あと <strong><?= goal.amount.toLocaleString() ?></strong> 円)
                <? } else { 
                    var remaining = goal.amount - progressForThisLevel;
                ?>
                  達成率: <strong><?= Math.round(rate) ?>%</strong> (あと <strong><?= Math.round(remaining).toLocaleString() ?></strong> 円)
                <? } ?>
              </p>
            </div>
        <? 
            previousTotalAmount += goal.amount;
          }
        });
        ?>
      </div>

    <? } else { ?>
      <div>
        <p>目標がまだ設定されていません。「目標を設定 / 編集する」ボタンから設定してください。</p>
      </div>
    <? } ?>

    <div>
      <h3>目標設定</h3>
      <button type="button" id="toggleGoalFormBtn" class="btn">目標を設定 / 編集する</button>
      <div id="goalFormWrapper" style="display: none; margin-top: 20px;">
        <form id="goalRecordForm" onsubmit="handleGoalRecordFormSubmit(this); return false;">
          <div class="goal-input-group">
            <label>Level 1：</label><input type="text" name="first_text" placeholder="例：家賃"><span>のため</span><input type="number" name="first_money" placeholder="50000"><span>円稼ぐ！</span>
          </div>
          <div class="goal-input-group">
            <label>Level 2：</label><input type="text" name="second_text" placeholder="例：ブランドバッグ"><span>のため</span><input type="number" name="second_money" placeholder="20000"><span>円稼ぐ！</span>
          </div>
          <div class="goal-input-group">
            <label>Level 3：</label><input type="text" name="third_text" placeholder="例：旅行"><span>のため</span><input type="number" name="third_money" placeholder="10000"><span>円稼ぐ！</span>
          </div>
          <div class="btn-frame">
            <input type="submit" value="登録" class="btn"/><div id="goal_submit_message"></div>
          </div>
        </form>
      </div>
    </div>
    
  </div>

  <div class="card2">
    
    <div>
      <h3>今月の給与（目安）</h3>
      <p class="salary-display">
        <?= typeof currentSalary === 'number' ? currentSalary.toLocaleString() + ' 円' : '計算中...' ?>
      </p>
    </div>

    <? if (goalRecord) { ?>
      <div>
        <h3>目標達成グラフ</h3>
        <div class="charts-grid">
          <div class="chart-item"><h4>Lv 1</h4><canvas id="goalChart1"></canvas></div>
          <div class="chart-item"><h4>Lv 2</h4><canvas id="goalChart2"></canvas></div>
          <div class="chart-item"><h4>Lv 3</h4><canvas id="goalChart3"></canvas></div>
        </div>
      </div>
    <? } ?>
    </div>
</div>

  <script>
  window.addEventListener('load', function() {
    document.getElementById('goalRecordForm').addEventListener('submit', function(event) {
      event.preventDefault();
    });


    google.script.run.withSuccessHandler(drawGoalCharts).getGoalAndSalaryData();

    const toggleBtn = document.getElementById('toggleGoalFormBtn');
    const goalForm = document.getElementById('goalFormWrapper');
    if (toggleBtn && goalForm) {
      toggleBtn.addEventListener('click', function() {
        const isHidden = goalForm.style.display === 'none';
        goalForm.style.display = isHidden ? 'block' : 'none';
        this.textContent = isHidden ? 'フォームを閉じる' : '目標を設定 / 編集する';
      });
    }
  });

  /** 目標登録フォームの送信ハンドラ */
  function handleGoalRecordFormSubmit(formObject) {
    const goalData = {
      first_text: formObject.first_text.value,
      first_money: formObject.first_money.value,
      second_text: formObject.second_text.value,
      second_money: formObject.second_money.value,
      third_text: formObject.third_text.value,
      third_money: formObject.third_money.value,
    };
    
    updateGoalRecordMessage('登録中...');
    google.script.run.withSuccessHandler(function(response) {
      updateGoalRecordMessage(response);
      setTimeout(() => window.location.reload(), 2000);
    }).saveGoalRecord(goalData);
  }
  
  /** 目標登録フォームのメッセージを更新 */
  function updateGoalRecordMessage(message) {
    document.getElementById('goal_submit_message').innerHTML = message;
  }

  /** 3つの円グラフを描画 */
  function drawGoalCharts(goalData) {
    if (!goalData) return;
    goalData.forEach(function(goal, index) {
      const ctx = document.getElementById('goalChart' + (index + 1)).getContext('2d');
      const percentage = goal.percentage;
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{ data: [percentage, 100 - percentage], backgroundColor: ['#28a745', '#e9ecef'] }]
        },
        options: {
          responsive: true, cutout: '70%',
          plugins: {
            legend: { display: false }, tooltip: { enabled: false },
            title: { display: true, text: percentage + '%', position: 'bottom', font: { size: 24, weight: 'bold' } }
          }
        }
      });
    });
  }
  </script>
</body>

</html>