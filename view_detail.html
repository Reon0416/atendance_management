<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('template.css').getContent(); ?>
</head>

<body>

  <header>
    <div class="header-links">
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>">å‹¤æ€ ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=health">ä½“èª¿ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=level">ç›®æ¨™ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>?empId=<?= selectedEmpId ?>&page=form">äº¤ä»£ç”³è«‹ãƒšãƒ¼ã‚¸</a>
      <a href="<?= getAppUrl() ?>">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </div>
  </header>

  <div class="container">
    <div class="card1">
      <div>
        <form id="healthForm" onsubmit="return handleHealthCheckFormSubmit(this)">
          <h3>ä½“èª¿ãƒã‚§ãƒƒã‚¯(å‡ºå‹¤å‰ã«å¿…ãšå›ç­”)</h3>
          <p style="font-weight: bold;">ä½“èª¿ã«ç•°å¸¸ãŒãªã„å ´åˆã¯ãã®ã¾ã¾é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
          <h4>ä½“èª¿ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</h4>

          <div class="radio-group">
            <label>
            <input type="radio" name="q0_mood" value="ğŸ˜ƒ å…ƒæ°—" checked>
            <span>ğŸ˜ƒ å…ƒæ°—</span>
            </label>
            <label>
            <input type="radio" name="q0_mood" value="ğŸ˜· å°‘ã—ã§ã‚‚ä½“èª¿ä¸è‰¯ã‚’æ„Ÿã˜ã‚‹">
            <span>ğŸ˜· å°‘ã—ã§ã‚‚ä½“èª¿ä¸è‰¯ã‚’æ„Ÿã˜ã‚‹</span>
            </label>
          </div>

          <div class="range-group">
            <label for="q1_range"><h4><strong>Q1.</strong> ä»Šæ—¥ã®ä½“èª¿ä¸è‰¯åº¦ã‚’ 0ã€œ10 ã§æ•™ãˆã¦ãã ã•ã„</h4></label>
            <div class="range-labels">
              <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
              <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
            </div>
            <input id="q1_range" name="q1_body_severity" type="range" min="0" max="10" step="1" value="0" />
            <div class="hint">0=å…ƒæ°—ï¼ / 3=è»½ã„é•å’Œæ„Ÿ / 6=ã—ã‚“ã©ã„ / 10=ã‹ãªã‚Šã¤ã‚‰ã„</div>
          </div>

          <div class="range-group">
            <label for="q2_range"><h4><strong>Q2.</strong> ä»Šæ—¥ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ 0ã€œ10 ã§æ•™ãˆã¦ãã ã•ã„</h4></label>
            <div class="range-labels">
              <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
              <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
            </div>
            <input id="q2_range" name="q2_body_severity" type="range" min="0" max="10" step="1" value="7" />
            <div class="hint">0=ãªã•ã™ãã‚‹ / 3=ã‚ã¾ã‚Šãªã„ / 6=ã‚ã‚‹ï¼ / 10=ãƒ•ãƒ«ãƒ‘ãƒ¯ãƒ¼ï¼ï¼ï¼</div>
          </div>

          <div class="btn-frame">
            <button type="submit" class="btn">é€ä¿¡</button>
          </div>
          <div id="health_check_message"></div>
          <div id="health_alert_area"></div>
        </form>
      </div>

      <div>
        <h3>ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</h3>
        <div class="date-display" id="current-date"></div>
        <div class="time-display" id="current-time"></div>
        <div class="status-display" id="current-status"></div>
        <div class="message-display" id="notification-message"></div>

        <div class="button-container">
          <button class="btn" id="start-work-btn" onclick="timeRecord('å‡ºå‹¤')">å‡ºå‹¤</button>
          <button class="btn" id="start-break-btn" onclick="timeRecord('ä¼‘æ†©é–‹å§‹')">ä¼‘æ†©é–‹å§‹</button>
          <button class="btn" id="end-break-btn" onclick="timeRecord('ä¼‘æ†©çµ‚äº†')">ä¼‘æ†©çµ‚äº†</button>
          <button class="btn" id="end-work-btn" onclick="timeRecord('é€€å‹¤')">é€€å‹¤</button>
        </div>
        <div class="btn-frame_return">
          <a href="<?= getAppUrl() ?>">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</a>
        </div>
      </div>
    </div>

    <div class="card2">
      <div>
        <span>åå‰:</span>
        <span>
        <?
            var emp = getEmployeeName()
        ?>
          <?= emp ?>
        </span>
      </div>

      <div>
        <h3>ä»Šæœˆã®çµ¦ä¸ï¼ˆç›®å®‰ï¼‰</h3>
        <p id="salary-display" style="font-size: 1.2em; font-weight: bold;">è¨ˆç®—ä¸­...</p>
      </div>

      <div>
        <h3>ä»Šæœˆã®ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼å±¥æ­´</h3>
        <div></div>
        <table border="1">
          <thead>
            <th>ç¨®åˆ¥</th>
            <th>æ—¥æ™‚</th>
          </thead>
          <tbody>
            <?
            // å‹¤æ€ æƒ…å ±ã‚’å–å¾— â€»æ™‚é–“ãŒãšã‚Œã‚‹å ´åˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„
            var record = getTimeClocks();
            // å‹¤æ€ æƒ…å ±ã®é…åˆ—ã®ç¹°ã‚Šè¿”ã—å‡¦ç†
            for (var i = 0; i <= record.length - 1; i++) {
            ?>
            <tr>
              <th>
                <?= record[i]['type'] ?>
              </th>
              <th>
                <?= record[i]['date'] ?>
              </th>
            </tr>
            <? } ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // https://developers.google.com/apps-script/guides/html/communication#forms
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', function() {
    preventFormSubmit(); 
    loadSalary();

    const toggleBtn = document.getElementById('toggleGoalFormBtn');
    const goalForm = document.getElementById('goalFormWrapper');

    if (toggleBtn && goalForm) {
      toggleBtn.addEventListener('click', function() {

        const isHidden = goalForm.style.display === 'none';
        goalForm.style.display = isHidden ? 'block' : 'none';

        this.textContent = isHidden ? 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹' : 'ç›®æ¨™ã‚’è¨­å®š / ç·¨é›†ã™ã‚‹';
      });
    }
  });

      /**
       *  ã‚¿ã‚¤ãƒ ã§ã‚³ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç™ºç«
       */ 
      const statusElement = document.getElementById('current-status');
      const messageElement = document.getElementById('notification-message');
      const startWorkBtn = document.getElementById('start-work-btn');
      const endWorkBtn = document.getElementById('end-work-btn');
      const startBreakBtn = document.getElementById('start-break-btn');
      const endBreakBtn = document.getElementById('end-break-btn');

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ™‚åˆ»ã‚’æ›´æ–°
      function updateTime() {
      const now = new Date();

      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const date = now.getDate();
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      const displayDate = `${year}å¹´${month}æœˆ${date}æ—¥`;
      const displayTime = `${hours}:${minutes}:${seconds}`;
      
      document.getElementById('current-date').textContent = displayDate;
      document.getElementById('current-time').textContent = displayTime;
     };
      setInterval(updateTime, 1000);
      updateTime();

      // UIã®çŠ¶æ…‹ã‚’ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«åŸºã¥ã„ã¦æ›´æ–°
      function updateUI(status) {
        statusElement.textContent = status;
        
        startWorkBtn.disabled = true;
        endWorkBtn.disabled = true;
        startBreakBtn.disabled = true;
        endBreakBtn.disabled = true;

        if (status === 'æœªå‡ºå‹¤') {
          startWorkBtn.disabled = false;
        } else if (status === 'å‡ºå‹¤ä¸­') {
          startBreakBtn.disabled = false;
          endWorkBtn.disabled = false;
        } else if (status === 'ä¼‘æ†©ä¸­') {
          endBreakBtn.disabled = false;
        }
      }
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æ‰“åˆ»å¿œç­”ã‚’å‡¦ç†ã—ã€UIã‚’æ›´æ–°
      function handleRecordResponse(result) {
        messageElement.textContent = result.statusMessage;
        updateUI(result.status);
      }

      // æ‰“åˆ»ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹
      function timeRecord(type) {
        messageElement.innerHTML = 'è¨˜éŒ²ä¸­...';
        google.script.run
          .withSuccessHandler(handleRecordResponse)
          .saveWorkRecord(type);
      }
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã¦UIã‚’åˆæœŸåŒ–
      google.script.run
        .withSuccessHandler(updateUI)
        .getInitialStatus();

      /**
       * å¥åº·ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç™ºç«
       */ 
      function handleHealthCheckFormSubmit(formEl) {
        updateHealthCheckMessage({ message: 'é€ä¿¡ä¸­....', isAlert: false });

        const formObject = {
          q1_mood: formEl.elements['q0_mood'].value,
          q2_severity: Number(formEl.elements['q1_body_severity'].value),
          q3_severity: Number(formEl.elements['q2_body_severity'].value)
        };

        google.script.run
          .withSuccessHandler(updateHealthCheckMessage)
          .withFailureHandler(err => {
            updateHealthCheckMessage({
              message: 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
              isAlert: true,
              alertMessage: err && err.message ? err.message : 'åŸå› ä¸æ˜ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚'
            });
          })
          .saveHealthCheck(formObject);

        return false;
      }

      /**
       * å¥åº·ãƒã‚§ãƒƒã‚¯ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®é€ä¿¡ãƒœã‚¿ãƒ³ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è­¦å‘Šã‚’æ›´æ–°
       */
      function updateHealthCheckMessage(response) {
        var messageDiv = document.getElementById('health_check_message');
        var alertDiv = document.getElementById('health_alert_area');

        alertDiv.innerHTML = '';
        messageDiv.innerHTML = response.message;

        if (response.isAlert) {
          alertDiv.innerHTML = response.alertMessage;
        }
      }

      /**
       * çµ¦ä¸æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹
       */
      function loadSalary() {
        google.script.run.withSuccessHandler(function(salary) {
          document.getElementById('salary-display').innerText = salary;
        }).calculateCurrentSalary();
      }

      function handleGoalRecordFormSubmit(formObject) {
        updateGoalRecordMessage('é€ä¿¡ä¸­....');
        google.script.run.withSuccessHandler(updateGoalRecordMessage).saveGoalRecord(formObject);
      }

      function updateGoalRecordMessage(message) {
        var div = document.getElementById('goal_submit_message');
        div.innerHTML = message;
      }
      

  </script>
</body>

</html>